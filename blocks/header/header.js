import{fetchPlaceholders,getMetadata}from"../../scripts/aem.js";import{loadFragment}from"../fragment/fragment.js";const isDesktop=window.matchMedia("(min-width: 900px)");function closeOnEscape(e){if("Escape"===e.code){const e=document.getElementById("nav"),t=e.querySelector(".nav-sections"),n=t.querySelector('[aria-expanded="true"]');n&&isDesktop.matches?(toggleAllNavSections(t),n.focus()):isDesktop.matches||(toggleMenu(e,t),e.querySelector("button").focus())}}function openOnKeydown(e){const t=document.activeElement;if("nav-drop"===t.className&&("Enter"===e.code||"Space"===e.code)){const e="true"===t.getAttribute("aria-expanded");toggleAllNavSections(t.closest(".nav-sections")),t.setAttribute("aria-expanded",e?"false":"true")}}function focusNavSection(){document.activeElement.addEventListener("keydown",openOnKeydown)}function toggleAllNavSections(e,t=!1){e.querySelectorAll(".nav-sections .default-content-wrapper > ul > li").forEach((e=>{e.setAttribute("aria-expanded",t)}))}function toggleMenu(e,t,n=null){const a=null!==n?!n:"true"===e.getAttribute("aria-expanded"),r=e.querySelector(".nav-hamburger button");document.body.style.overflowY=a||isDesktop.matches?"":"hidden",e.setAttribute("aria-expanded",a?"false":"true"),toggleAllNavSections(t,a||isDesktop.matches?"false":"true"),r.setAttribute("aria-label",a?"Open navigation":"Close navigation");const o=t.querySelectorAll(".nav-drop");isDesktop.matches&&o.forEach((e=>{e.hasAttribute("tabindex")||(e.setAttribute("role","button"),e.setAttribute("tabindex",0),e.addEventListener("focus",focusNavSection))})),!a||isDesktop.matches?window.addEventListener("keydown",closeOnEscape):window.removeEventListener("keydown",closeOnEscape)}function getDirectTextContent(e){const t=e.querySelector(":scope > a");return t?t.textContent.trim():Array.from(e.childNodes).filter((e=>e.nodeType===Node.TEXT_NODE)).map((e=>e.textContent)).join(" ")}async function buildBreadcrumbsFromNavTree(e,t){const n=[],a=document.querySelector(".nav-brand a").href;let r=Array.from(e.querySelectorAll("a")).find((e=>e.href===t));if(r)do{const e=r.querySelector(":scope > a");n.unshift({title:getDirectTextContent(r),url:e?e.href:null}),r=r.closest("ul")?.closest("li")}while(r);else t!==a&&n.unshift({title:getMetadata("og:title"),url:t});const o=(await fetchPlaceholders()).breadcrumbsHomeLabel||"Home";return n.unshift({title:o,url:a}),n.length>1&&(n[n.length-1].url=null),n[n.length-1]["aria-current"]="page",n}async function buildBreadcrumbs(){const e=document.createElement("nav");e.className="breadcrumbs";const t=await buildBreadcrumbsFromNavTree(document.querySelector(".nav-sections"),document.location.href),n=document.createElement("ol");return n.append(...t.map((e=>{const t=document.createElement("li");if(e["aria-current"]&&t.setAttribute("aria-current",e["aria-current"]),e.url){const n=document.createElement("a");n.href=e.url,n.textContent=e.title,t.append(n)}else t.textContent=e.title;return t}))),e.append(n),e}export default async function decorate(e){const t=getMetadata("nav"),n=t?new URL(t).pathname:"/nav",a=await loadFragment(n),r=document.createElement("nav");for(r.id="nav";a.firstElementChild;)r.append(a.firstElementChild);["brand","sections","tools"].forEach(((e,t)=>{const n=r.children[t];n&&n.classList.add(`nav-${e}`)}));const o=r.querySelector(".nav-brand").querySelector(".button");o&&(o.className="",o.closest(".button-container").className="");const s=r.querySelector(".nav-sections");s&&s.querySelectorAll(":scope .default-content-wrapper > ul > li").forEach((e=>{e.querySelector("ul")&&e.classList.add("nav-drop"),e.addEventListener("click",(()=>{if(isDesktop.matches){const t="true"===e.getAttribute("aria-expanded");toggleAllNavSections(s),e.setAttribute("aria-expanded",t?"false":"true")}if(window.matchMedia("(max-width: 899px)").matches){const t="true"===e.getAttribute("aria-expanded");toggleAllNavSections(s),e.setAttribute("aria-expanded",t?"false":"true")}}))}));const c=document.createElement("div");c.classList.add("nav-hamburger"),c.innerHTML='<button type="button" aria-controls="nav" aria-label="Open navigation">\n      <span class="nav-hamburger-icon"></span>\n    </button>',c.addEventListener("click",(()=>toggleMenu(r,s))),r.prepend(c),r.setAttribute("aria-expanded","false"),toggleMenu(r,s,isDesktop.matches),isDesktop.addEventListener("change",(()=>toggleMenu(r,s,isDesktop.matches)));const i=document.createElement("div");i.className="nav-wrapper",i.append(r),e.append(i),"true"===getMetadata("breadcrumbs").toLowerCase()&&i.append(await buildBreadcrumbs())}